<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Layered Payments Simulator — The Next VISA?</title>
<meta name="description" content="v4-like build with original UI behaviors, single preset, NO charts. Includes Backlog delay (days).">
<style>
  :root { color-scheme: dark; --bg:#0b1020; --panel:#121933; --text:#e6ecff; --muted:#95a3c7; --accent:#5aa9ff; --ok:#7CE38B; --warn:#ffd166; --bad:#ff6b6b; }
  * { box-sizing:border-box; }
  body { margin:0; font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; background:var(--bg); color:var(--text); }
  .wrap { max-width:1100px; margin:24px auto 80px; padding:0 16px; }
  h1 { font-size:22px; margin:0 0 6px; }
  .sub { color:var(--muted); margin-bottom:18px; }
  .controls { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
  button { background:var(--accent); color:#001331; border:0; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; }
  button.secondary { background:#22305e; color:#e6ecff; }
  .layout { display:grid; grid-template-columns: 1.1fr 1fr; gap:16px; }
  .panel { background:var(--panel); border:1px solid #1a2448; border-radius:12px; padding:14px; }
  h2 { font-size:16px; margin:0 0 8px; color:#cfe0ff; }
  .row { display:grid; grid-template-columns: 1fr auto; gap:10px 12px; align-items:center; padding:8px 0; border-top:1px dashed #24305b; }
  .row:first-child { border-top:0; padding-top:0; }
  .lbl { color:#d9e5ff; }
  input[type="range"] { width:360px; }
  input[type="number"] { width:120px; padding:6px 8px; border-radius:8px; border:1px solid #2b3a6a; background:#0e1430; color:var(--text); }
  .kpis { display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; margin-top:10px; }
  .card { background:#0d1431; border:1px solid #253166; border-radius:12px; padding:12px; }
  .card h3 { font-size:13px; color:#cfe0ff; margin:0 0 6px; }
  .val { font-size:20px; font-weight:800; }
  .ok { color: var(--ok); } .warn { color: var(--warn); } .bad { color: var(--bad); }
  pre { background:#0e1430; border:1px solid #2b3a6a; border-radius:12px; padding:12px; overflow:auto; }
  .note { color:#cfe0ff; font-size:12px; margin-top:6px; }
  .foot { color:#8ea4de; font-size:12px; margin-top:18px; }
  a { color:#9ed0ff; }
  @media (max-width: 980px){ .layout{ grid-template-columns: 1fr; } }
</style>
</head>
<body>
<div class="wrap">
  <h1>Layered Payments Simulator — VISA? preset</h1>
  <div class="sub">v4-style UI. Only change: single preset named VISA?. Charts removed. Includes Backlog delay (days).</div>

  <div class="controls">
    <button id="loadPreset">Reset to VISA?</button>
    <button class="secondary" id="exportJson">Export JSON</button>
    <button class="secondary" id="copyJson">Copy JSON</button>
    <button class="secondary" id="shareLink">Copy Shareable Link</button>
  </div>

  <div class="layout">
    <div id="sections"></div>

    <div>
      <div class="panel">
        <h2>Derived metrics</h2>
        <div class="kpis">
          <div class="card">
            <h3>HTLC demand / sec</h3>
            <div id="kpiDemand" class="val">-</div>
          </div>
          <div class="card">
            <h3>Total HTLC slots</h3>
            <div id="kpiSlots" class="val">-</div>
          </div>
          <div class="card">
            <h3>Slot utilization</h3>
            <div id="kpiUtil" class="val">-</div>
          </div>
          <div class="card">
            <h3>L1 backstop tx/day</h3>
            <div id="kpiL1" class="val">-</div>
          </div>
          <div class="card">
            <h3>Backlog delay (days)</h3>
            <div id="kpiDelay" class="val">-</div>
          </div>
          <div class="card">
            <h3>Unsafe region?</h3>
            <div id="kpiUnsafe" class="val">-</div>
          </div>
          <div class="card">
            <h3>Notes</h3>
            <div id="kpiNote" class="val" style="font-size:13px; font-weight:600;">-</div>
          </div>
        </div>
        <div class="note">Backlog delay ≈ (L1 load per day ÷ L1 capacity per day). &lt;1 = less than a day; &gt;1 = multi-day.</div>
      </div>

      <div class="panel">
        <h2>Preset JSON</h2>
        <pre id="jsonOut" aria-live="polite"></pre>
        <div class="note">Export or Copy the JSON for your simulator.</div>
      </div>
    </div>
  </div>

  <div class="foot">v4 single-preset build, charts removed.</div>
</div>

<script>
// ----- Schema -----
const schema = [
  {
    title: "Population",
    fields: [
      ["users_millions","Users (millions)","range",0,500,1],
      ["share_self_ln_pct","Self-custodial LN (%)","range",0,100,1],
      ["share_key_layer_pct","Key-holding layer (%)","range",0,100,1],
      ["share_custodial_pct","Pure custodial (%)","range",0,100,1],
    ]
  },
  {
    title: "Activity",
    fields: [
      ["payments_per_active_user_per_day","Payments per active user per day","range",0,20,0.1],
      ["active_users_daily_pct","% of users active daily","range",0,100,1],
    ]
  },
  {
    title: "LN Demand Mapping",
    subtitle: "Only the portion of payments that touch LN create HTLC demand.",
    fields: [
      ["self_ln_touch_pct","Self-LN: LN touch (%)","range",0,100,1],
      ["self_ln_aggregation_ratio","Self-LN aggregation (payments per HTLC)","range",1,200,1],
      ["key_layer_touch_ln_pct","Key-layer: % of payments that touch LN","range",0,100,1],
      ["key_layer_user_to_ln_aggregation_ratio","Key-layer: user→LN aggregation (payments per HTLC)","range",1,200,1],
      ["custodial_touch_ln_pct","Custodial: % of payments that touch LN","range",0,100,1],
      ["custodial_aggregation_ratio","Custodial: aggregation (payments per HTLC)","range",1,500,1],
    ]
  },
  {
    title: "LN Graph Envelope",
    fields: [
      ["avg_path_hops","Avg. path length (hops)","range",1,12,1],
      ["mpp_splits_per_payment","MPP splits per payment","range",1,32,1],
      ["avg_inflight_seconds","Avg. in-flight duration (sec)","range",1,600,1],
      ["network_routers_count","Network routers (pro LSPs)","range",1,5000,1],
      ["channels_per_router_avg","Channels per router (avg)","range",1,2000,1],
      ["htlc_slots_per_channel","HTLC slots per channel","range",1,483,1],
      ["usable_slot_fraction_pct","Usable slot fraction (safety, %)","range",1,100,1],
      ["min_htlc_sats","Min-HTLC (sats)","range",1,100000,1],
    ]
  },
  {
    title: "Enforcement / Shock",
    fields: [
      ["self_ln_forced_closure_pct","Self-LN: % channels forced to close","range",0,100,1],
      ["key_layer_backstop_users_per_tx","Key-layer: L1 backstop users per tx","range",1,10000,1],
      ["key_layer_backstop_users_pct","Key-layer: % of users needing backstop","range",0,100,1],
      ["l1_capacity_tx_per_day","L1 capacity (tx/day)","range",1000,1000000,1000],
      ["avg_tx_per_ln_channel_closure","Avg. tx per LN channel closure","range",1,10,1],
      ["user_channels_per_self_ln_user","User channels per self-LN user","range",1,10,1],
    ]
  },
  {
    title: "Enforcement Windows",
    subtitle: "Windows are time to get on-chain in adversarial conditions.",
    fields: [
      ["self_ln_enforcement_window_days","Self-LN enforcement window (days)","range",1,30,1],
      ["key_layer_backstop_window_days","Key-layer backstop window (days)","range",1,90,1],
      ["jamming_target_slot_pct","Jamming target (percent of slots to occupy)","range",0,100,1],
    ]
  },
];

// ----- Single preset (only change vs v4: one preset, named VISA?) -----
const presetVisa = {
  id: "visa",
  name: "VISA?",
  values: {
    users_millions: 100,
    share_self_ln_pct: 33,
    share_key_layer_pct: 25,
    share_custodial_pct: 42,

    payments_per_active_user_per_day: 1.5,
    active_users_daily_pct: 60,

    self_ln_touch_pct: 100,
    self_ln_aggregation_ratio: 1,

    key_layer_touch_ln_pct: 80,
    key_layer_user_to_ln_aggregation_ratio: 8,

    custodial_touch_ln_pct: 80,
    custodial_aggregation_ratio: 200,

    avg_path_hops: 4,
    mpp_splits_per_payment: 6,
    avg_inflight_seconds: 60,
    network_routers_count: 300,
    channels_per_router_avg: 150,
    htlc_slots_per_channel: 211,
    usable_slot_fraction_pct: 50,
    min_htlc_sats: 1000,

    self_ln_forced_closure_pct: 5,
    key_layer_backstop_users_per_tx: 200,
    key_layer_backstop_users_pct: 5,
    l1_capacity_tx_per_day: 150000,
    avg_tx_per_ln_channel_closure: 4,
    user_channels_per_self_ln_user: 1,

    self_ln_enforcement_window_days: 14,
    key_layer_backstop_window_days: 30,
    jamming_target_slot_pct: 50
  }
};

// ----- State, UI, helpers -----
const $sections = document.getElementById("sections");
const $jsonOut = document.getElementById("jsonOut");
const $kpiDemand = document.getElementById("kpiDemand");
const $kpiSlots = document.getElementById("kpiSlots");
const $kpiUtil = document.getElementById("kpiUtil");
const $kpiL1 = document.getElementById("kpiL1");
const $kpiDelay = document.getElementById("kpiDelay");
const $kpiUnsafe = document.getElementById("kpiUnsafe");
const $kpiNote = document.getElementById("kpiNote");

let state = structuredClone(presetVisa.values);

// URL hash encoding/decoding
function encodeState(obj){ return btoa(unescape(encodeURIComponent(JSON.stringify(obj)))); }
function decodeState(s){ try { return JSON.parse(decodeURIComponent(escape(atob(s)))); } catch { return null; } }

function loadFromHash(){
  if (location.hash && location.hash.length > 2){
    const data = decodeState(location.hash.slice(1));
    if (data && typeof data === 'object'){ state = Object.assign({}, state, data); }
  }
}
loadFromHash();

function updateHash(){
  const s = encodeState(state);
  history.replaceState(null, "", "#" + s);
}

function makeRow(key, label, type, min, max, step) {
  const row = document.createElement("div");
  row.className = "row";
  const left = document.createElement("div");
  const right = document.createElement("div");

  const lbl = document.createElement("div");
  lbl.className = "lbl";
  lbl.textContent = label;
  left.appendChild(lbl);

  const range = document.createElement("input");
  range.type = type;
  range.min = min; range.max = max; range.step = step;
  range.value = state[key];

  const num = document.createElement("input");
  num.type = "number"; num.step = step; num.min = min; num.max = max; num.value = state[key];

  right.appendChild(range);
  right.appendChild(num);

  const sync = (from, to) => {
    to.value = from.value;
    state[key] = Number(from.value);
    scheduleRender();
  };
  range.addEventListener("input", () => sync(range, num));
  num.addEventListener("input", () => {
    const v = Math.max(min, Math.min(max, Number(num.value)));
    num.value = v; range.value = v; state[key] = v; scheduleRender();
  });

  row.appendChild(left);
  row.appendChild(right);
  return row;
}

function buildUI() {
  $sections.innerHTML = "";
  for (const block of schema) {
    const panel = document.createElement("section");
    panel.className = "panel";
    const h = document.createElement("h2"); h.textContent = block.title; panel.appendChild(h);
    if (block.subtitle) {
      const p = document.createElement("div"); p.className = "sub"; p.textContent = block.subtitle; panel.appendChild(p);
    }
    for (const f of block.fields) {
      panel.appendChild(makeRow(...f));
    }
    $sections.appendChild(panel);
  }
}
buildUI();

// ----- Calculations -----
function calcDerived(s){
  const users = s.users_millions * 1e6;
  const activeUsers = users * (s.active_users_daily_pct/100);
  const paymentsPerDay = activeUsers * s.payments_per_active_user_per_day;

  // Map to LN-touching payments and aggregation into HTLCs
  const selfUsers = users * (s.share_self_ln_pct/100);
  const keyUsers = users * (s.share_key_layer_pct/100);
  const custUsers = users * (s.share_custodial_pct/100);

  const selfPayments = paymentsPerDay * (selfUsers/users) * (s.self_ln_touch_pct/100);
  const keyPayments  = paymentsPerDay * (keyUsers/users)  * (s.key_layer_touch_ln_pct/100);
  const custPayments = paymentsPerDay * (custUsers/users) * (s.custodial_touch_ln_pct/100);

  const htlcSelf = selfPayments / Math.max(1, s.self_ln_aggregation_ratio);
  const htlcKey  = keyPayments  / Math.max(1, s.key_layer_user_to_ln_aggregation_ratio);
  const htlcCust = custPayments / Math.max(1, s.custodial_aggregation_ratio);

  const htlcPerDay = htlcSelf + htlcKey + htlcCust;
  const htlcPerSec = htlcPerDay / 86400;

  // Capacity envelope
  const routers = s.network_routers_count;
  const channelsPerRouter = s.channels_per_router_avg;
  const slotsPerChannel = s.htlc_slots_per_channel * (s.usable_slot_fraction_pct/100);
  const totalSlots = Math.floor(routers * channelsPerRouter * slotsPerChannel);
  const avgInFlightSec = Math.max(1, s.avg_inflight_seconds);
  const slotThroughputPerSec = totalSlots / avgInFlightSec;

  // Utilization
  const util = (htlcPerSec / slotThroughputPerSec) || 0;

  // L1 backstop
  const keyUsersNeedingBackstop = keyUsers * (s.key_layer_backstop_users_pct/100);
  const txForKeyBackstopPerDay = keyUsersNeedingBackstop / Math.max(1, s.key_layer_backstop_users_per_tx);
  const forcedClosures = (selfUsers * (s.self_ln_forced_closure_pct/100)) / Math.max(1, s.user_channels_per_self_ln_user);
  const lnCloseTxPerDay = forcedClosures * s.avg_tx_per_ln_channel_closure;
  const l1LoadPerDay = txForKeyBackstopPerDay + lnCloseTxPerDay;

  const l1Capacity = s.l1_capacity_tx_per_day;
  const backlogPerDay = Math.max(0, l1LoadPerDay - l1Capacity);

  // Backlog delay (days)
  const delayDays = l1Capacity > 0 ? (l1LoadPerDay / l1Capacity) : Infinity;

  // Unsafe flags
  const unsafeLN = delayDays > (s.self_ln_enforcement_window_days || 0);
  const unsafeKey = delayDays > (s.key_layer_backstop_window_days || 0);
  const unsafe = unsafeLN || unsafeKey;

  let note = "Within windows";
  if (unsafeLN && unsafeKey) note = "Both LN and key-layer windows at risk";
  else if (unsafeLN) note = "LN window at risk";
  else if (unsafeKey) note = "Key-layer window at risk";

  return {
    users, activeUsers, paymentsPerDay,
    htlcPerDay, htlcPerSec, totalSlots, slotThroughputPerSec, util,
    l1LoadPerDay, l1Capacity, backlogPerDay, delayDays,
    unsafeLN, unsafeKey, unsafe, note
  };
}

// ----- Rendering -----
function renderJSON() {
  const payload = { id: "visa", name: "VISA?", values: { ...state } };
  $jsonOut.textContent = JSON.stringify(payload, null, 2);
}
function renderKPIs(d){
  const fmt = n => (Math.abs(n) >= 1000 ? Math.round(n).toLocaleString() : n.toFixed(2));
  $kpiDemand.textContent = fmt(d.htlcPerSec);
  $kpiSlots.textContent = Math.round(d.totalSlots).toLocaleString();
  const utilPct = (d.util*100);
  $kpiUtil.textContent = utilPct.toFixed(1) + "%";
  $kpiUtil.className = "val " + (utilPct<60 ? "ok" : utilPct<90 ? "warn" : "bad");
  $kpiL1.textContent = Math.round(d.l1LoadPerDay).toLocaleString();
  const delay = d.delayDays;
  $kpiDelay.textContent = (delay === Infinity ? "∞" : delay.toFixed(2));
  $kpiDelay.className = "val " + (delay<1 ? "ok" : delay<=Math.max(1, (state.self_ln_enforcement_window_days+state.key_layer_backstop_window_days)/2) ? "warn" : "bad");
  $kpiUnsafe.textContent = d.unsafe ? "YES" : "no";
  $kpiUnsafe.className = "val " + (d.unsafe ? "bad" : "ok");
  $kpiNote.textContent = d.note;
}
function renderAll(){
  const d = calcDerived(state);
  renderJSON();
  renderKPIs(d);
  updateHash();
}
let raf = 0;
function scheduleRender(){ cancelAnimationFrame(raf); raf = requestAnimationFrame(renderAll); }
renderAll();

// ----- Buttons -----
document.getElementById("loadPreset").onclick = () => {
  state = structuredClone(presetVisa.values);
  buildUI();
  renderAll();
};

document.getElementById("exportJson").onclick = renderJSON;

document.getElementById("copyJson").onclick = async () => {
  try { await navigator.clipboard.writeText($jsonOut.textContent); alert("Preset JSON copied."); }
  catch {
    const ta = document.createElement("textarea"); ta.value = $jsonOut.textContent;
    document.body.appendChild(ta); ta.select(); document.execCommand("copy"); ta.remove();
    alert("Copied via fallback.");
  }
};

document.getElementById("shareLink").onclick = async () => {
  try { await navigator.clipboard.writeText(location.href); alert("Shareable URL copied."); } catch {}
};
</script>
</body>
</html>
